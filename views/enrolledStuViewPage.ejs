<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE-edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="<%= csrfToken %>">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- <link rel="stylesheet" href="./css/styles.css"> -->
    <title><%= title %></title>
</head>
<body>
    <div class="grid grid-cols-4">
        <div class="col-start-2 col-span-2">
            <%- include ('header.ejs') %>
            <div class="py-2 text-sm font-semibold border-b-2" style="display: flex; justify-content: space-between;">
                <a href="/view-course/<%= course.id %>?currentUserId=<%= currentUser.id %>" class="text-blue-600 text-sm font-semibold border-b-2 py-2">Back to Course</a>
                <h1 class="text-black-600 text-sm font-semibold"><%= currentUser.firstName %> <%= currentUser.lastName %> <br> <a href="/signout" class="text-green-600 text-lg font-semibold">Signout</a> </h1>
            </div>
            <h1 class="text-black-600 text-2xl font-semibold border-b-2 py-2 mb-2">
                <strong>Course: </strong> <%= course.courseName %> <br>
                <strong>Chapter: </strong> <%= chapter.chapterName %>    
            </h1>
                <!-- Find an enrollment record that matches the current user, course, chapter, and page -->
                <%
                    const userId = currentUser.id;
                    const courseId = course.id;
                    const chapterId = chapter.id;
                    const currentPageId = pages[currentPageIndex].id;

                    // Find an enrollment record that matches the current user, course, chapter, and page
                    const enrollment = enrols.find(enrollment => (
                        enrollment.userId === userId &&
                        enrollment.courseId === courseId &&
                        enrollment.chapterId === chapterId &&
                        enrollment.pageId === currentPageId &&
                        enrollment.completed === true
                    ));
                %>

                <form method="POST" action="/mark-as-complete?currentCourseId=<%= course.id %>&currentChapterId=<%= chapter.id %>&currentUserId=<%= currentUser.id %>&currentPageId=<%= currentPageIndex + 1 %>">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                    <% if (enrollment) { %>
                        <button class="bg-green-200 border border-green-500 text-green-600 text-center font-semibold py-2 rounded w-full mt-1 mb-1" disabled>Completed</button>
                    <% } else { %>
                        <button type="submit" class="bg-white-600 border-2 bor der-green-500 text-green-600 text-center py-2 rounded font-medium w-full mt-1 mb-1 hover:bg-green-500 hover:text-white hover:border-white-800">Mark As Complete</button>
                    <% } %>
                </form>

            <!-- Display the current page content -->
            <div class="bg-blue-100 border border-gray-300 p-4 rounded-lg shadow hover:shadow-lg">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-semibold m-2"><%= pages[currentPageIndex].title %></h2>
                </div>
                <h3 class="text-xl m-2"><%= pages[currentPageIndex].content %></h3>
            </div>
            <!-- Navigation options for enrolled students -->
            <div class="mb-5 flex justify-between">
                <script>
                    const currentPageIndex = <%= currentPageIndex %>;
                    const maxPageIndex = <%= pages.length - 1 %>;
                    const chapterId = '<%= chapter.id %>';
                    const currentUserId = '<%= currentUser.id %>';

                    if (currentPageIndex > 0) {
                        document.write(`<a href="/view-chapter/${chapterId}/viewpage?currentUserId=${currentUserId}&currentPageIndex=${currentPageIndex - 1}" class="bg-blue-500 text-white text-center px-5 py-2 rounded font-medium w-1/2 m-1 mt-3 hover:bg-blue-600">Previous Page</a>`);
                    }
                    if (currentPageIndex < maxPageIndex) {
                        document.write(`<a href="/view-chapter/${chapterId}/viewpage?currentUserId=${currentUserId}&currentPageIndex=${currentPageIndex + 1}" class="bg-blue-500 text-white text-center px-5 py-2 rounded font-medium w-1/2 m-1 mt-3 hover-bg-blue-600">Next Page</a>`);
                    }
                </script>
            </div>
        </div>
    </div>
    <!-- <script>
        function changePage(chapterId, currentUserId, newIndex) {
            window.location.href = `/view-chapter/${chapterId}/viewpage?currentUserId=${currentUserId}&currentPageIndex=${newIndex}`;
        }
        function markAsComplete(userId, pageId) {
            var token = document.querySelector("meta[name='csrf-token']").getAttribute("content");
            fetch(`/mark-as-complete/${userId}/${pageId}`, {
                method: 'POST',
                headers: { "Content-type": "application/json", "_csrf":token},
            })
            .then(data => {
                // Handle the response if needed
                if (data == "Success") {
                    // You can update the UI to indicate that the page is marked as complete
                    alert('Page marked as complete');
                } else {
                    alert('Failed to mark page as complete');
                }
            })
            .catch(error => {
                console.error('Error marking page as complete', error);
            });
        }
    </script> -->
</body>
</html>